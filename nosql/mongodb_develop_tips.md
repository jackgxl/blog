# mongodDB 开发规范

## mongoDB库设计
>```
>mongodb数据库命名规范：db_xxxx
>库名全部小写
>禁止使用任何"_"(下划线)外的特殊字符
>禁止使用数字打头的库名
>数据库名最多为 64字符
>不要与系统保留的数据库名相同,这些数据库名包括:admin,local,config,system等
>```

## mongoDB集合的设计
>```
>mongodb集合命名规范：t_xxxx
>集合名全部小写
>禁止使用任何 " _ "（下划线） 以外的特殊字符
>禁止使用数字打头的集合名称
>集合名称最多为 64字符
>为了避免库级锁带来的问题，应尽量对写入较大的集合使用“单库单集合”的结构，所以对于新增业务应尽量创建新库，而不是在现有库中创建新集合
>
>```

## mongoDB文档的设计
>```
文档中的 key 禁止使用任何 " _ "（下划线）以外的特殊字符
禁止使用 _id ，如：向 _id 中写入自定义内容中写入自定义内容
尽量不要让数组字段成为查询条件
尽量存放统一了大小写后的数据
尽量将同样类型的文档存放在一个集合中，将不同类型的文档分散在不同的集合中
如果字段较大，应尽量压缩存放
如果字段较大且会成为查询条件，例如一长串的url，尽量转成md5后存放
```

## mongoDB索引的设计
>```
优先使用覆盖索引
尽量遵循最左前缀原则
索引名称长度不要超过 128 字符
尽可能的将单列索引并入组合索引以降低数量
在数据量较大的时候，MongoDB 索引的创建是一个缓慢的过程，所以应当在上前线或数据量变得很大前尽量评估，按需创建会用到的索引
MongoDB 的索引创建是库级锁，在索引创建时该集合所在库不可读写，所以如需添加索引，请联系DBA
MongoDB 支持 TTL 索引，该索引能够按你的需要自动删除XXX秒之前的数据并会尽量选择在业务低峰期执行删除操作
如果你存放的数据是地理位置信息，比如：经纬度数据。那么可以在该字段上添加 MongoDB 支持的地理索引：2d 及 2dsphere，但他们是不同的，混用会导致结果不准确
```

## MongoDB操作性能

* 防SQL注入
>* 写mongo查询时不使用不加任何限制的文本框输入查询条件，业务方应对查询的关键字段做出限制，避免通配符等模糊形式的查询，比如时间字段使用时间控件输入，不可让用户手工输入
>
>* 使用delete或者update前，先进行查询，预估范围和数量，确认后，在不影响数据库的正常使用的前提下，分批update或者delete.

* 编码规范：
>mongo存储编码统一为为UTF-8，应用连接请设置utf-8,例如：python, PHP, java JDBC设置编码为UTF-8

* 建立索引注意事项
>如果数据量巨大，建索引需要慎重，因为耗时非常长。
如果不使用后台建索引方式，索引建立过程数据库锁定，无法读写数据，但建立速度相对较快；
如果使用后台建索引方式，索引建立过程可以读写数据，但建立速度较慢。
如果在建立某个索引的过程中kill -9终止进程，repair过程会仍然会建立该索引 




* 索引中的-1和1是不一样的，一个是逆序，一个是正序，应当根据自己的业务场景建立适合的索引排序，需要注意的是{a:1,b:-1} 和 {a:-1,b:1}是一样的

* 在开发业务的时候尽量检查自己的程序性能,可以使用 explain() 函数检查你的查询执行详情，另外 hint() 函数相当于 MySQL 中的 force index()

* 查询中的某些 操作符可能会导致性能低下，如ne，not，exists，nin，or，尽量在业务中不要使用

    ```
    $exist：因为松散的文档结构导致查询必须遍历每一个文档
    $ne：如果当取反的值为大多数，则会扫描整个索引
    $not：可能会导致查询优化器不知道应当使用哪个索引，所以会经常退化为全表扫描
    $nin：全表扫描
    or：有多少个条件就会查询多少次，最后合并结果集，所以尽可能的使用in
    
    ```

* 如果你的结合体积/文档数固定，那么建议创建 capped（封顶）集合，这种集合的写入性能非常高并无需专门清理老旧数据，需要注意的是 capped 表不支持remove() 和 update()

* 在写入数据的时候，如果你需要实现类似 MySQL 中 INSERT INTO ON DUPLICATE KEY UPDATE 的功能，那么可以选择 upsert() 函数

* 不要一次取出太多的数据进行排序，MongoDB 目前支持对32MB以内的结果集进行排序，如果需要排序，那么请尽量限制结果集中的数据量

* MongoDB 的聚合框架非常好用，能够通过简单的语法实现复杂的统计查询，并且性能也不错

* 如果需要清理掉一个集合中的所有数据，那么 remove() 的性能是非常低下的，该场景下应当使用 drop() 
remove() 是逐行操作，所以在删除大量数据的时候性能很差

* 写入大量数据的时候可以选择使用 batchInsert，但目前 MongoDB 每一次能够接受的最大消息长度为48MB，如果超出48MB，将会被自动拆分为多个48MB的消息

* 在使用数组字段做为查询条件的时候，将于覆盖索引无缘 
这是因为数组是保存在索引中的，即便将数组字段从需要返回的字段中剔除，这样的索引仍然无法覆盖查询

* 在查询中如果有范围条件,那么尽量和定值条件放在一起进行过滤,并在创建索引的时候将定值查询字段放在范围查询字段前


### 参考资源:

<a>http://blog.csdn.net/qq994406030/article/details/53425636
<a>http://www.cnblogs.com/zhengyun_ustc/archive/2013/01/25/2875962.html


